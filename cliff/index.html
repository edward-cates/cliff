<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Grouping Tool</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script type="module" src="script.js"></script>
</head>
<body>
    <div id="app">
        <v-app>
            <v-dialog v-model="selectedPhoto" max-width="800">
                <v-card v-if="selectedPhoto">
                    <v-card-title class="text-h5">
                        {{ selectedPhoto.metadata.originalPath }}
                    </v-card-title>
                    <v-card-text>
                        <div class="text-center">
                            <v-img
                                :src="selectedPhoto.processedImageUrl"
                                max-height="600"
                                contain
                                class="mb-4"
                            ></v-img>
                            <div class="text-body-1">
                                {{ new Date(selectedPhoto.metadata.timestamp).toLocaleString() }}
                            </div>
                            <v-chip
                                :color="selectedPhoto.metadata.hasFace ? 'success' : 'error'"
                                class="mt-2"
                            >
                                {{ selectedPhoto.metadata.hasFace ? 'Face Detected' : 'No Face' }}
                                <template v-if="selectedPhoto.metadata.confidence">
                                    ({{ Math.round(selectedPhoto.metadata.confidence * 100) }}%)
                                </template>
                            </v-chip>
                        </div>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="primary" @click="selectedPhoto = null">Close</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <v-dialog v-model="showGroupFilesModal" max-width="800">
                <v-card v-if="selectedGroup">
                    <v-card-title class="d-flex align-center">
                        <v-icon color="primary" class="mr-2">mdi-link-variant</v-icon>
                        Chain {{ selectedGroup.chainId }} Details
                        <v-spacer></v-spacer>
                        <v-btn icon @click="showGroupFilesModal = false">
                            <v-icon>mdi-close</v-icon>
                        </v-btn>
                    </v-card-title>
                    <v-divider></v-divider>
                    <v-card-text>
                        <v-row>
                            <v-col cols="12">
                                <v-card variant="outlined" class="mb-4">
                                    <v-card-title class="text-subtitle-1">
                                        <v-icon color="primary" size="small" class="mr-2">mdi-image-multiple</v-icon>
                                        Groups in Chain
                                    </v-card-title>
                                    <v-divider></v-divider>
                                    <v-list density="compact">
                                        <template v-for="group in groups.filter(g => g.chainId === selectedGroup.chainId)" :key="group.id">
                                            <v-list-item>
                                                <template v-slot:prepend>
                                                    <v-avatar size="40" rounded="0">
                                                        <v-img :src="group.photos[0].processedImageUrl"></v-img>
                                                    </v-avatar>
                                                </template>
                                                <v-list-item-title class="text-body-2">Group {{ group.id }}</v-list-item-title>
                                                <v-list-item-subtitle class="text-caption">
                                                    {{ group.photos.length }} photos
                                                </v-list-item-subtitle>
                                                <template v-slot:append>
                                                    <v-chip
                                                        :color="group.hasFace ? 'success' : 'error'"
                                                        size="small"
                                                        variant="tonal"
                                                    >
                                                        {{ group.hasFace ? 'Has Face' : 'No Face' }}
                                                    </v-chip>
                                                </template>
                                            </v-list-item>
                                            <v-divider v-if="group.nextGroup"></v-divider>
                                            <v-list-item v-if="group.nextGroup" class="justify-center">
                                                <v-icon color="primary" size="small" class="mr-2">mdi-link-variant</v-icon>
                                                <v-chip color="info" size="small" variant="tonal">
                                                    {{ Math.round(group.similarity * 100) }}% match
                                                </v-chip>
                                            </v-list-item>
                                            <v-divider v-if="group.nextGroup"></v-divider>
                                        </template>
                                    </v-list>
                                </v-card>
                            </v-col>
                            <v-col cols="12">
                                <v-card variant="outlined" class="mb-4">
                                    <v-card-title class="text-subtitle-1">
                                        <v-icon color="primary" size="small" class="mr-2">mdi-camera</v-icon>
                                        Photos in Group {{ selectedGroup.id }}
                                    </v-card-title>
                                    <v-divider></v-divider>
                                    <v-list density="compact">
                                        <v-list-item
                                            v-for="photo in selectedGroup.photos"
                                            :key="photo.metadata.originalPath"
                                            class="mb-1"
                                        >
                                            <template v-slot:prepend>
                                                <v-avatar size="40" rounded="0">
                                                    <v-img :src="photo.processedImageUrl"></v-img>
                                                </v-avatar>
                                            </template>
                                            <v-list-item-title class="text-body-2">{{ photo.metadata.originalPath }}</v-list-item-title>
                                            <v-list-item-subtitle class="text-caption">
                                                {{ new Date(photo.metadata.timestamp).toLocaleString() }}
                                            </v-list-item-subtitle>
                                            <template v-slot:append>
                                                <v-chip
                                                    :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                    size="small"
                                                    variant="tonal"
                                                >
                                                    {{ photo.metadata.hasFace ? 'Face' : 'No Face' }}
                                                </v-chip>
                                            </template>
                                        </v-list-item>
                                    </v-list>
                                </v-card>
                            </v-col>
                        </v-row>
                    </v-card-text>
                    <v-card-actions class="pa-4">
                        <v-spacer></v-spacer>
                        <v-btn
                            color="primary"
                            variant="tonal"
                            @click="showGroupFilesModal = false"
                        >
                            Close
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <v-main>
                <v-container>
                    <v-stepper v-model="currentStep" class="mb-6">
                        <v-stepper-header>
                            <template v-for="(step, index) in steps" :key="index">
                                <v-stepper-item
                                    :value="index + 1"
                                    :title="step"
                                ></v-stepper-item>
                            </template>
                        </v-stepper-header>

                        <v-stepper-window>
                            <!-- Step 1: Photo Selection -->
                            <v-stepper-window-item :value="1">
                                <v-card class="pa-4">
                                    <v-card-title>Select Photos</v-card-title>
                                    <v-card-text>
                                        <v-file-input
                                            v-model="files"
                                            multiple
                                            accept="image/*"
                                            label="Select photos"
                                            prepend-icon="mdi-camera"
                                            @change="handleFileSelect"
                                            class="mb-4"
                                            hide-details
                                            show-size
                                            truncate-length="15"
                                        ></v-file-input>

                                        <v-btn
                                            v-if="!isProcessing && processedPhotos.length > 0"
                                            color="primary"
                                            class="mb-4"
                                            @click="groupByTime"
                                        >
                                            Group by time
                                        </v-btn>

                                        <v-card
                                            v-if="isProcessing"
                                            class="mb-4"
                                            variant="outlined"
                                        >
                                            <v-card-text>
                                                <v-progress-linear
                                                    v-model="processingProgress"
                                                    color="primary"
                                                    height="25"
                                                >
                                                    <template v-slot:default="{ value }">
                                                        <strong>{{ Math.ceil(value) }}%</strong>
                                                    </template>
                                                </v-progress-linear>
                                                <div class="text-center mt-2">
                                                    Detecting faces... {{ processedCount }} of {{ totalPhotos }}
                                                    <div v-if="estimatedTimeRemaining" class="text-caption">
                                                        Elapsed: {{ formatTime(elapsedTime) }} | Remaining: {{ formatTime(estimatedTimeRemaining) }}
                                                    </div>
                                                </div>
                                            </v-card-text>
                                        </v-card>

                                        <v-alert
                                            v-if="sortedPhotos.length > 0"
                                            type="info"
                                            class="mb-4"
                                            variant="tonal"
                                        >
                                            Photos are sorted by confidence in face detection. Photos with confidence closest to 50% appear first, making it easier to review uncertain detections. Click any photo to toggle between face detected and no face.
                                        </v-alert>

                                        <div class="d-flex flex-wrap gap-2 mb-4">
                                            <v-chip
                                                :color="selectedFilter === 'all' ? 'primary' : undefined"
                                                @click="selectedFilter = 'all'"
                                            >
                                                All Successful ({{ processedPhotos.length }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'face' ? 'primary' : undefined"
                                                @click="selectedFilter = 'face'"
                                            >
                                                Face ({{ photosWithFaces }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'noFace' ? 'primary' : undefined"
                                                @click="selectedFilter = 'noFace'"
                                            >
                                                No Face ({{ photosWithoutFaces }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'failed' ? 'primary' : undefined"
                                                @click="selectedFilter = 'failed'"
                                            >
                                                Failed ({{ failedPhotos.length }})
                                            </v-chip>
                                        </div>

                                        <v-row>
                                            <template v-for="(photo, index) in sortedPhotos" :key="index">
                                                <v-col cols="2">
                                                    <v-card @click="toggleFaceDetection(photo)" class="h-100">
                                                        <template v-if="selectedFilter === 'failed'">
                                                            <v-card-text class="pa-2">
                                                                <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                <div class="text-caption text-truncate text-error">{{ photo.error }}</div>
                                                            </v-card-text>
                                                        </template>
                                                        <template v-else>
                                                            <v-img
                                                                :src="photo.processedImageUrl"
                                                                aspect-ratio="1"
                                                                cover
                                                            >
                                                                <template v-slot:placeholder>
                                                                    <v-row class="fill-height ma-0" align="center" justify="center">
                                                                        <v-progress-circular indeterminate color="primary"></v-progress-circular>
                                                                    </v-row>
                                                                </template>
                                                            </v-img>
                                                            <v-card-text class="pa-2">
                                                                <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                <v-chip
                                                                    :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                    size="small"
                                                                    class="mt-1"
                                                                >
                                                                    {{ photo.metadata.hasFace ? 'Face Detected' : 'No Face' }} ({{ photo.metadata.confidence ? photo.metadata.confidence.toFixed(2) : '0.00' }})
                                                                </v-chip>
                                                            </v-card-text>
                                                        </template>
                                                    </v-card>
                                                </v-col>
                                            </template>
                                        </v-row>
                                    </v-card-text>
                                </v-card>
                            </v-stepper-window-item>

                            <!-- Step 2: Face Detection -->
                            <v-stepper-window-item :value="2">
                                <v-card class="pa-4">
                                    <v-card-title>Face Detection Results</v-card-title>
                                    <v-card-actions>
                                        <v-spacer></v-spacer>
                                    </v-card-actions>
                                    <v-card-text>
                                        <v-btn
                                            v-if="!isProcessing && processedPhotos.length > 0"
                                            color="primary"
                                            size="x-large"
                                            block
                                            class="mb-4"
                                            @click="groupByTime"
                                        >
                                            Group by time
                                        </v-btn>

                                        <div class="d-flex flex-wrap gap-2 mb-4">
                                            <v-chip
                                                :color="selectedFilter === 'all' ? 'primary' : undefined"
                                                @click="selectedFilter = 'all'"
                                            >
                                                All Successful ({{ processedPhotos.length }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'face' ? 'primary' : undefined"
                                                @click="selectedFilter = 'face'"
                                            >
                                                Face ({{ photosWithFaces }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'noFace' ? 'primary' : undefined"
                                                @click="selectedFilter = 'noFace'"
                                            >
                                                No Face ({{ photosWithoutFaces }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'failed' ? 'primary' : undefined"
                                                @click="selectedFilter = 'failed'"
                                            >
                                                Failed ({{ failedPhotos.length }})
                                            </v-chip>
                                        </div>

                                        <v-row>
                                            <template v-for="(photo, index) in sortedPhotos" :key="index">
                                                <v-col cols="2">
                                                    <v-card @click="toggleFaceDetection(photo)" class="h-100">
                                                        <template v-if="selectedFilter === 'failed'">
                                                            <v-card-text class="pa-2">
                                                                <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                <div class="text-caption text-truncate text-error">{{ photo.error }}</div>
                                                            </v-card-text>
                                                        </template>
                                                        <template v-else>
                                                            <v-img
                                                                :src="photo.processedImageUrl"
                                                                aspect-ratio="1"
                                                                cover
                                                            >
                                                                <template v-slot:placeholder>
                                                                    <v-row class="fill-height ma-0" align="center" justify="center">
                                                                        <v-progress-circular indeterminate color="primary"></v-progress-circular>
                                                                    </v-row>
                                                                </template>
                                                            </v-img>
                                                            <v-card-text class="pa-2">
                                                                <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                <v-chip
                                                                    :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                    size="small"
                                                                    class="mt-1"
                                                                >
                                                                    {{ photo.metadata.hasFace ? 'Face Detected' : 'No Face' }} ({{ photo.metadata.confidence ? photo.metadata.confidence.toFixed(2) : '0.00' }})
                                                                </v-chip>
                                                            </v-card-text>
                                                        </template>
                                                    </v-card>
                                                </v-col>
                                            </template>
                                        </v-row>
                                    </v-card-text>
                                </v-card>
                            </v-stepper-window-item>

                            <!-- Step 3: Group Formation -->
                            <v-stepper-window-item :value="3">
                                <v-card class="pa-4">
                                    <v-card-title>Group Formation</v-card-title>
                                    <v-card-text>
                                        <v-row v-if="groups.length > 0" class="mb-4">
                                            <v-col cols="12" sm="6">
                                                <v-card variant="outlined">
                                                    <v-card-text class="text-center">
                                                        <div class="text-h4">{{ groups.length }}</div>
                                                        <div class="text-subtitle-1">Total Groups</div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                            <v-col cols="12" sm="6">
                                                <v-card variant="outlined">
                                                    <v-card-text class="text-center">
                                                        <div class="text-h4">{{ groups.filter(g => g.nextGroup).length }}</div>
                                                        <div class="text-subtitle-1">Total Connections</div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                        </v-row>

                                        <v-list>
                                            <template v-for="chain in groups.reduce((chains, group) => {
                                                if (group.isFirstInChain) {
                                                    const chain = [group];
                                                    let current = group;
                                                    while (current.nextGroup) {
                                                        const next = groups.find(g => g.id === current.nextGroup.id);
                                                        if (next) {
                                                            chain.push(next);
                                                            current = next;
                                                        } else {
                                                            break;
                                                        }
                                                    }
                                                    chains.push(chain);
                                                }
                                                return chains;
                                            }, [])" :key="chain[0].id">
                                                <v-list-item class="mb-4">
                                                    <v-card class="w-100">
                                                        <v-card-title>
                                                            <div class="d-flex align-center">
                                                                <span>Chain {{ chain[0].chainId }}</span>
                                                                <v-spacer></v-spacer>
                                                                <v-btn
                                                                    color="primary"
                                                                    variant="text"
                                                                    class="ml-2"
                                                                    @click="showGroupFiles(chain[0])"
                                                                >
                                                                    <v-icon start>mdi-file-document-outline</v-icon>
                                                                    Show Files
                                                                </v-btn>
                                                            </div>
                                                        </v-card-title>
                                                        <v-card-text>
                                                            <div class="d-flex align-center overflow-x-auto">
                                                                <template v-for="(group, index) in chain" :key="group.id">
                                                                    <div class="d-flex align-center">
                                                                        <div class="d-flex flex-column align-center">
                                                                            <div class="text-caption mb-1">Group {{ group.id }}</div>
                                                                            <div class="d-flex overflow-x-auto">
                                                                                <v-card
                                                                                    v-for="photo in group.photos"
                                                                                    :key="photo.metadata.originalPath"
                                                                                    class="mr-2"
                                                                                    width="150"
                                                                                    @click="selectedPhoto = photo"
                                                                                    style="cursor: pointer"
                                                                                >
                                                                                    <v-img
                                                                                        :src="photo.processedImageUrl"
                                                                                        aspect-ratio="1"
                                                                                        cover
                                                                                    ></v-img>
                                                                                    <v-card-text class="pa-2">
                                                                                        <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                                        <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                                        <v-chip
                                                                                            :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                                            size="small"
                                                                                            class="mt-1"
                                                                                        >
                                                                                            {{ photo.metadata.hasFace ? 'Face' : 'No Face' }}
                                                                                        </v-chip>
                                                                                    </v-card-text>
                                                                                </v-card>
                                                                            </div>
                                                                        </div>
                                                                        <div v-if="index < chain.length - 1" class="d-flex align-center mx-2">
                                                                            <v-icon color="primary" size="large">mdi-link-variant</v-icon>
                                                                            <v-chip color="info" variant="tonal" class="mx-2">
                                                                                {{ Math.round(group.similarity * 100) }}% match
                                                                            </v-chip>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </v-card-text>
                                                    </v-card>
                                                </v-list-item>
                                                <v-divider class="my-4"></v-divider>
                                            </template>
                                        </v-list>

                                        <!-- Unmatched Groups Section -->
                                        <v-expansion-panels v-if="unmatchedGroups.length > 0" class="mt-4">
                                            <v-expansion-panel>
                                                <v-expansion-panel-title>
                                                    <v-icon start>mdi-image-multiple</v-icon>
                                                    Unmatched Groups ({{ unmatchedGroups.length }})
                                                </v-expansion-panel-title>
                                                <v-expansion-panel-text>
                                                    <v-list>
                                                        <v-list-item v-for="group in unmatchedGroups" :key="group.id" class="mb-4">
                                                            <v-card variant="outlined" class="w-100">
                                                                <v-card-text>
                                                                    <div class="d-flex align-center mb-2">
                                                                        <span class="text-caption text-grey">
                                                                            {{ group.photos.length }} photos
                                                                        </span>
                                                                    </div>
                                                                    <div class="d-flex overflow-x-auto">
                                                                        <v-card
                                                                            v-for="photo in group.photos"
                                                                            :key="photo.metadata.originalPath"
                                                                            class="mr-2"
                                                                            width="150"
                                                                            @click="selectedPhoto = photo"
                                                                            style="cursor: pointer"
                                                                        >
                                                                            <v-img
                                                                                :src="photo.processedImageUrl"
                                                                                aspect-ratio="1"
                                                                                cover
                                                                            ></v-img>
                                                                            <v-card-text class="pa-2">
                                                                                <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                                <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                                <v-chip
                                                                                    :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                                    size="small"
                                                                                    class="mt-1"
                                                                                >
                                                                                    {{ photo.metadata.hasFace ? 'Face' : 'No Face' }}
                                                                                </v-chip>
                                                                            </v-card-text>
                                                                        </v-card>
                                                                    </div>
                                                                </v-card-text>
                                                            </v-card>
                                                        </v-list-item>
                                                    </v-list>
                                                </v-expansion-panel-text>
                                            </v-expansion-panel>
                                        </v-expansion-panels>

                                        <v-expansion-panels v-if="processedPhotos.length > 0" class="mt-4">
                                            <v-expansion-panel>
                                                <v-expansion-panel-title>
                                                    <template v-slot:default="{ expanded }">
                                                        <v-row no-gutters>
                                                            <v-col cols="4" class="d-flex justify-start">
                                                                <v-icon color="primary" size="small" class="mr-2">mdi-image</v-icon>
                                                                Unused Photos
                                                            </v-col>
                                                            <v-col cols="8" class="text--secondary">
                                                                <v-fade-transition leave-absolute>
                                                                    <span v-if="expanded" key="0">
                                                                        Click to collapse
                                                                    </span>
                                                                    <span v-else key="1">
                                                                        {{ processedPhotos.length }} photos
                                                                    </span>
                                                                </v-fade-transition>
                                                            </v-col>
                                                        </v-row>
                                                    </template>
                                                </v-expansion-panel-title>
                                                <v-expansion-panel-text>
                                                    <v-row>
                                                        <v-col cols="2" v-for="photo in processedPhotos" :key="photo.metadata.originalPath">
                                                            <v-card @click="selectedPhoto = photo" class="h-100">
                                                                <v-img
                                                                    :src="photo.processedImageUrl"
                                                                    aspect-ratio="1"
                                                                    cover
                                                                ></v-img>
                                                                <v-card-text class="pa-2">
                                                                    <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                    <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                    <v-chip
                                                                        :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                        size="small"
                                                                        class="mt-1"
                                                                    >
                                                                        {{ photo.metadata.hasFace ? 'Face' : 'No Face' }}
                                                                    </v-chip>
                                                                </v-card-text>
                                                            </v-card>
                                                        </v-col>
                                                    </v-row>
                                                </v-expansion-panel-text>
                                            </v-expansion-panel>
                                        </v-expansion-panels>
                                    </v-card-text>
                                    <v-card-actions>
                                        <v-spacer></v-spacer>
                                        <v-btn color="primary" @click="exportGroupInfo">
                                            <v-icon start>mdi-export</v-icon>
                                            Export Group Information
                                        </v-btn>
                                    </v-card-actions>
                                </v-card>
                            </v-stepper-window-item>
                        </v-stepper-window>
                    </v-stepper>
                </v-container>
            </v-main>
        </v-app>
    </div>
</body>
</html>
