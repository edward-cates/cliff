<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Grouping Tool</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script type="module" src="script.js"></script>
</head>
<body>
    <div id="app">
        <v-app>
            <v-dialog v-model="selectedPhoto" max-width="800">
                <v-card v-if="selectedPhoto">
                    <v-card-title class="text-h5">
                        {{ selectedPhoto.metadata.originalPath }}
                    </v-card-title>
                    <v-card-text>
                        <div class="text-center">
                            <v-img
                                :src="selectedPhoto.processedImageUrl"
                                max-height="600"
                                contain
                                class="mb-4"
                            ></v-img>
                            <div class="text-body-1">
                                {{ new Date(selectedPhoto.metadata.timestamp).toLocaleString() }}
                            </div>
                            <v-chip
                                :color="selectedPhoto.metadata.hasFace ? 'success' : 'error'"
                                class="mt-2"
                            >
                                {{ selectedPhoto.metadata.hasFace ? 'Face Detected' : 'No Face' }}
                                <template v-if="selectedPhoto.metadata.confidence">
                                    ({{ Math.round(selectedPhoto.metadata.confidence * 100) }}%)
                                </template>
                            </v-chip>
                        </div>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="primary" @click="selectedPhoto = null">Close</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <v-dialog v-model="showGroupFilesModal" max-width="800">
                <v-card v-if="selectedGroup">
                    <v-card-title>
                        Group {{ selectedGroup.id }} Files
                        <v-spacer></v-spacer>
                        <v-btn icon @click="showGroupFilesModal = false">
                            <v-icon>mdi-close</v-icon>
                        </v-btn>
                    </v-card-title>
                    <v-card-text>
                        <v-list>
                            <v-list-subheader>Original Photos</v-list-subheader>
                            <v-list-item
                                v-for="photo in selectedGroup.photos"
                                :key="photo.metadata.originalPath"
                            >
                                <v-list-item-title>{{ photo.metadata.originalPath }}</v-list-item-title>
                                <v-list-item-subtitle>
                                    {{ new Date(photo.metadata.timestamp).toLocaleString() }}
                                </v-list-item-subtitle>
                            </v-list-item>
                            <v-list-subheader>Matched Photos</v-list-subheader>
                            <v-list-item
                                v-for="match in selectedGroup.matches"
                                :key="match.photo.metadata.originalPath"
                            >
                                <v-list-item-title>{{ match.photo.metadata.originalPath }}</v-list-item-title>
                                <v-list-item-subtitle>
                                    {{ new Date(match.photo.metadata.timestamp).toLocaleString() }}
                                    ({{ Math.round(match.similarity * 100) }}% match)
                                </v-list-item-subtitle>
                            </v-list-item>
                        </v-list>
                    </v-card-text>
                </v-card>
            </v-dialog>

            <v-main>
                <v-container>
                    <v-stepper v-model="currentStep" class="mb-6">
                        <v-stepper-header>
                            <template v-for="(step, index) in steps" :key="index">
                                <v-stepper-item
                                    :value="index + 1"
                                    :title="step"
                                ></v-stepper-item>
                            </template>
                        </v-stepper-header>

                        <v-stepper-window>
                            <!-- Step 1: Photo Selection -->
                            <v-stepper-window-item :value="1">
                                <v-card class="pa-4">
                                    <v-card-title>Select Photos</v-card-title>
                                    <v-card-text>
                                        <v-file-input
                                            v-model="files"
                                            multiple
                                            accept="image/*"
                                            label="Select photos"
                                            prepend-icon="mdi-camera"
                                            @change="handleFileSelect"
                                            class="mb-4"
                                            hide-details
                                            show-size
                                            truncate-length="15"
                                        ></v-file-input>

                                        <v-btn
                                            v-if="!isProcessing && processedPhotos.length > 0"
                                            color="primary"
                                            class="mb-4"
                                            @click="groupByTime"
                                        >
                                            Group by time
                                        </v-btn>

                                        <v-card
                                            v-if="isProcessing"
                                            class="mb-4"
                                            variant="outlined"
                                        >
                                            <v-card-text>
                                                <v-progress-linear
                                                    v-model="processingProgress"
                                                    color="primary"
                                                    height="25"
                                                >
                                                    <template v-slot:default="{ value }">
                                                        <strong>{{ Math.ceil(value) }}%</strong>
                                                    </template>
                                                </v-progress-linear>
                                                <div class="text-center mt-2">
                                                    <template v-if="processingProgress < 50">
                                                        Detecting faces... {{ processedCount }} of {{ totalPhotos }}
                                                    </template>
                                                    <template v-else>
                                                        Creating groups... {{ processedCount }} of {{ totalPhotos }}
                                                    </template>
                                                </div>
                                            </v-card-text>
                                        </v-card>

                                        <v-alert
                                            v-if="sortedPhotos.length > 0"
                                            type="info"
                                            class="mb-4"
                                            variant="tonal"
                                        >
                                            Photos are sorted by confidence in face detection. Photos with confidence closest to 50% appear first, making it easier to review uncertain detections. Click any photo to toggle between face detected and no face.
                                        </v-alert>

                                        <div class="d-flex flex-wrap gap-2 mb-4">
                                            <v-chip
                                                :color="selectedFilter === 'all' ? 'primary' : undefined"
                                                @click="selectedFilter = 'all'"
                                            >
                                                All Successful ({{ processedPhotos.length }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'face' ? 'primary' : undefined"
                                                @click="selectedFilter = 'face'"
                                            >
                                                Face ({{ photosWithFaces }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'noFace' ? 'primary' : undefined"
                                                @click="selectedFilter = 'noFace'"
                                            >
                                                No Face ({{ photosWithoutFaces }})
                                            </v-chip>
                                            <v-chip
                                                :color="selectedFilter === 'failed' ? 'primary' : undefined"
                                                @click="selectedFilter = 'failed'"
                                            >
                                                Failed ({{ failedPhotos.length }})
                                            </v-chip>
                                        </div>

                                        <v-row>
                                            <template v-for="(photo, index) in sortedPhotos" :key="index">
                                                <v-col cols="2">
                                                    <v-card @click="toggleFaceDetection(photo)" class="h-100">
                                                        <v-img
                                                            :src="photo.processedImageUrl"
                                                            aspect-ratio="1"
                                                            cover
                                                        >
                                                            <template v-slot:placeholder>
                                                                <v-row class="fill-height ma-0" align="center" justify="center">
                                                                    <v-progress-circular indeterminate color="primary"></v-progress-circular>
                                                                </v-row>
                                                            </template>
                                                        </v-img>
                                                        <v-card-text class="pa-2">
                                                            <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                            <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                            <v-chip
                                                                :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                size="small"
                                                                class="mt-1"
                                                            >
                                                                {{ photo.metadata.hasFace ? 'Face Detected' : 'No Face' }} ({{ photo.metadata.confidence ? photo.metadata.confidence.toFixed(2) : '0.00' }})
                                                            </v-chip>
                                                        </v-card-text>
                                                    </v-card>
                                                </v-col>
                                            </template>
                                        </v-row>
                                    </v-card-text>
                                    <v-card-actions>
                                        <v-spacer></v-spacer>
                                    </v-card-actions>
                                </v-card>
                            </v-stepper-window-item>

                            <!-- Step 2: Face Detection -->
                            <v-stepper-window-item :value="2">
                                <v-card class="pa-4">
                                    <v-card-title>Face Detection Results</v-card-title>
                                    <v-card-text>
                                        <v-row>
                                            <v-col cols="12" sm="4">
                                                <v-card variant="outlined">
                                                    <v-card-text class="text-center">
                                                        <div class="text-h4">{{ sortedPhotos.length }}</div>
                                                        <div class="text-subtitle-1">Total Photos</div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                            <v-col cols="12" sm="4">
                                                <v-card variant="outlined">
                                                    <v-card-text class="text-center">
                                                        <div class="text-h4">{{ photosWithFaces }}</div>
                                                        <div class="text-subtitle-1">Photos with Faces</div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                            <v-col cols="12" sm="4">
                                                <v-card variant="outlined">
                                                    <v-card-text class="text-center">
                                                        <div class="text-h4">{{ photosWithoutFaces }}</div>
                                                        <div class="text-subtitle-1">Photos without Faces</div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                        </v-row>

                                        <v-row class="mt-4">
                                            <template v-for="(photo, index) in sortedPhotos" :key="index">
                                                <v-col cols="12" sm="6" md="4" lg="3">
                                                    <v-card>
                                                        <v-img
                                                            :src="photo.processedImageUrl"
                                                            aspect-ratio="1"
                                                            cover
                                                        >
                                                            <template v-slot:placeholder>
                                                                <v-row class="fill-height ma-0" align="center" justify="center">
                                                                    <v-progress-circular indeterminate color="primary"></v-progress-circular>
                                                                </v-row>
                                                            </template>
                                                        </v-img>
                                                        <v-card-text class="pa-2">
                                                            <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                            <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                            <v-chip
                                                                :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                size="small"
                                                                class="mt-1"
                                                            >
                                                                {{ photo.metadata.hasFace ? 'Face Detected' : 'No Face' }}
                                                            </v-chip>
                                                        </v-card-text>
                                                    </v-card>
                                                </v-col>
                                            </template>
                                        </v-row>
                                    </v-card-text>
                                    <v-card-actions>
                                        <v-spacer></v-spacer>
                                        <v-btn color="primary" @click="currentStep = 3">Continue to Grouping</v-btn>
                                    </v-card-actions>
                                </v-card>
                            </v-stepper-window-item>

                            <!-- Step 3: Group Formation -->
                            <v-stepper-window-item :value="3">
                                <v-card class="pa-4">
                                    <v-card-title>Group Formation</v-card-title>
                                    <v-card-text>
                                        <v-row v-if="groups.length > 0" class="mb-4">
                                            <v-col cols="12" sm="6">
                                                <v-card variant="outlined">
                                                    <v-card-text class="text-center">
                                                        <div class="text-h4">{{ groupsWithMatches }}</div>
                                                        <div class="text-subtitle-1">Total Groups</div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                            <v-col cols="12" sm="6">
                                                <v-card variant="outlined">
                                                    <v-card-text class="text-center">
                                                        <div class="text-h4">{{ groups.reduce((sum, g) => sum + g.matches.length, 0) }}</div>
                                                        <div class="text-subtitle-1">Total Matches</div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                        </v-row>

                                        <v-list>
                                            <v-list-item
                                                v-for="group in groups.filter(g => g.matches.length > 0)"
                                                :key="group.id"
                                                class="mb-4"
                                            >
                                                <v-card class="w-100">
                                                    <v-card-title>
                                                        Group {{ group.id }}
                                                        <v-btn
                                                            color="primary"
                                                            variant="text"
                                                            class="ml-2"
                                                            @click="showGroupFiles(group)"
                                                        >
                                                            <v-icon start>mdi-file-document-outline</v-icon>
                                                            Show Files
                                                        </v-btn>
                                                    </v-card-title>
                                                    <v-card-text>
                                                        <div class="d-flex overflow-x-auto">
                                                            <v-card
                                                                v-for="photo in group.photos"
                                                                :key="photo.metadata.originalPath"
                                                                class="mr-2"
                                                                width="150"
                                                                @click="selectedPhoto = photo"
                                                                style="cursor: pointer"
                                                            >
                                                                <v-img
                                                                    :src="photo.processedImageUrl"
                                                                    aspect-ratio="1"
                                                                    cover
                                                                ></v-img>
                                                                <v-card-text class="pa-2">
                                                                    <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                    <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                    <v-chip
                                                                        :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                        size="small"
                                                                        class="mt-1"
                                                                    >
                                                                        {{ photo.metadata.hasFace ? 'Face' : 'No Face' }}
                                                                    </v-chip>
                                                                </v-card-text>
                                                            </v-card>
                                                            <v-card
                                                                v-for="match in group.matches"
                                                                :key="match.photo.metadata.originalPath"
                                                                class="mr-2"
                                                                width="150"
                                                                @click="selectedPhoto = match.photo"
                                                                style="cursor: pointer"
                                                            >
                                                                <v-img
                                                                    :src="match.photo.processedImageUrl"
                                                                    aspect-ratio="1"
                                                                    cover
                                                                ></v-img>
                                                                <v-card-text class="pa-2">
                                                                    <div class="text-caption text-truncate">{{ match.photo.metadata.originalPath }}</div>
                                                                    <div class="text-caption text-truncate">{{ new Date(match.photo.metadata.timestamp).toLocaleString() }}</div>
                                                                    <v-chip
                                                                        color="info"
                                                                        size="small"
                                                                        class="mt-1"
                                                                    >
                                                                        {{ Math.round(match.similarity * 100) }}% match
                                                                    </v-chip>
                                                                </v-card-text>
                                                            </v-card>
                                                        </div>
                                                    </v-card-text>
                                                </v-card>
                                            </v-list-item>
                                        </v-list>

                                        <v-expansion-panels v-if="groups.some(g => g.matches.length === 0)" class="mt-4">
                                            <v-expansion-panel>
                                                <v-expansion-panel-title>
                                                    <template v-slot:default="{ expanded }">
                                                        <v-row no-gutters>
                                                            <v-col cols="4" class="d-flex justify-start">
                                                                Groups Without Matches
                                                            </v-col>
                                                            <v-col cols="8" class="text--secondary">
                                                                <v-fade-transition leave-absolute>
                                                                    <span v-if="expanded" key="0">
                                                                        Click to collapse
                                                                    </span>
                                                                    <span v-else key="1">
                                                                        {{ groups.filter(g => g.matches.length === 0).length }} groups
                                                                    </span>
                                                                </v-fade-transition>
                                                            </v-col>
                                                        </v-row>
                                                    </template>
                                                </v-expansion-panel-title>
                                                <v-expansion-panel-text>
                                                    <v-list>
                                                        <v-list-item
                                                            v-for="group in groups.filter(g => g.matches.length === 0)"
                                                            :key="group.id"
                                                            class="mb-4"
                                                        >
                                                            <v-card class="w-100">
                                                                <v-card-title>
                                                                    Group {{ group.id }}
                                                                    <v-btn
                                                                        color="primary"
                                                                        variant="text"
                                                                        class="ml-2"
                                                                        @click="showGroupFiles(group)"
                                                                    >
                                                                        <v-icon start>mdi-file-document-outline</v-icon>
                                                                        Show Files
                                                                    </v-btn>
                                                                </v-card-title>
                                                                <v-card-text>
                                                                    <div class="d-flex overflow-x-auto">
                                                                        <v-card
                                                                            v-for="photo in group.photos"
                                                                            :key="photo.metadata.originalPath"
                                                                            class="mr-2"
                                                                            width="150"
                                                                            @click="selectedPhoto = photo"
                                                                            style="cursor: pointer"
                                                                        >
                                                                            <v-img
                                                                                :src="photo.processedImageUrl"
                                                                                aspect-ratio="1"
                                                                                cover
                                                                            ></v-img>
                                                                            <v-card-text class="pa-2">
                                                                                <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                                <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                                <v-chip
                                                                                    :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                                    size="small"
                                                                                    class="mt-1"
                                                                                >
                                                                                    {{ photo.metadata.hasFace ? 'Face' : 'No Face' }}
                                                                                </v-chip>
                                                                            </v-card-text>
                                                                        </v-card>
                                                                    </div>
                                                                </v-card-text>
                                                            </v-card>
                                                        </v-list-item>
                                                    </v-list>
                                                </v-expansion-panel-text>
                                            </v-expansion-panel>
                                        </v-expansion-panels>

                                        <v-expansion-panels v-if="groups.length > 0" class="mt-4">
                                            <v-expansion-panel>
                                                <v-expansion-panel-title>
                                                    <template v-slot:default="{ expanded }">
                                                        <v-row no-gutters>
                                                            <v-col cols="4" class="d-flex justify-start">
                                                                Unmatched Photos
                                                            </v-col>
                                                            <v-col cols="8" class="text--secondary">
                                                                <v-fade-transition leave-absolute>
                                                                    <span v-if="expanded" key="0">
                                                                        Click to collapse
                                                                    </span>
                                                                    <span v-else key="1">
                                                                        {{ processedPhotos.length - groups.reduce((sum, g) => sum + g.photos.length + g.matches.length, 0) }} photos
                                                                    </span>
                                                                </v-fade-transition>
                                                            </v-col>
                                                        </v-row>
                                                    </template>
                                                </v-expansion-panel-title>
                                                <v-expansion-panel-text>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        <v-card
                                                            v-for="photo in processedPhotos.filter(p => !groups.some(g => 
                                                                g.photos.includes(p) || g.matches.some(m => m.photo === p)
                                                            ))"
                                                            :key="photo.metadata.originalPath"
                                                            width="150"
                                                            @click="selectedPhoto = photo"
                                                            style="cursor: pointer"
                                                        >
                                                            <v-img
                                                                :src="photo.processedImageUrl"
                                                                aspect-ratio="1"
                                                                cover
                                                            ></v-img>
                                                            <v-card-text class="pa-2">
                                                                <div class="text-caption text-truncate">{{ photo.metadata.originalPath }}</div>
                                                                <div class="text-caption text-truncate">{{ new Date(photo.metadata.timestamp).toLocaleString() }}</div>
                                                                <v-chip
                                                                    :color="photo.metadata.hasFace ? 'success' : 'error'"
                                                                    size="small"
                                                                    class="mt-1"
                                                                >
                                                                    {{ photo.metadata.hasFace ? 'Face' : 'No Face' }}
                                                                </v-chip>
                                                            </v-card-text>
                                                        </v-card>
                                                    </div>
                                                </v-expansion-panel-text>
                                            </v-expansion-panel>
                                        </v-expansion-panels>
                                    </v-card-text>
                                    <v-card-actions>
                                        <v-spacer></v-spacer>
                                        <v-btn color="primary" @click="exportGroupInfo">
                                            <v-icon start>mdi-export</v-icon>
                                            Export Group Information
                                        </v-btn>
                                    </v-card-actions>
                                </v-card>
                            </v-stepper-window-item>
                        </v-stepper-window>
                    </v-stepper>
                </v-container>
            </v-main>
        </v-app>
    </div>
</body>
</html>
